#! /bin/sh

CODENAME=$(lsb_release -s -c)
if [ -z "$1" ]; then
  KERNEL_VERSION=`uname -r`
else
  KERNEL_VERSION="$1"
fi
case "$CODENAME" in
  bionic)
    APTNAME=linux-source-$(echo $KERNEL_VERSION | sed 's/-.*$//');;
  *)
    APTNAME=linux-image-${KERNEL_VERSION};;
esac

[ -d work ] && rm -rf work
mkdir work
cd work
apt-get source "$APTNAME"
pkgname=`awk '/Source:/{print $2}' linux*.dsc`
if [ x"$pkgname" = x"linux-hwe-edge" ]; then
  ltsname=hwe-edge
elif [ x"$pkgname" = x"linux-hwe" ]; then
  ltsname=hwe
else
  ltsname=`echo $pkgname|sed 's/^linux-lts-//'`
  if [ x"$ltsname" = x"$pkgname" ]; then
    ltsname=master
  fi
fi
sourcedir=`find . -name 'linux-*' -type d`
if [ -z "$sourcedir" -o ! -d "$sourcedir" ]; then
  echo "ERROR!  something wrong"
  exit 1
fi
cd "$sourcedir"

cat ../../patches/*.patch | patch -p1
if [ -r "../../patches/dsdt.hex" ]; then
  cp ../../patches/dsdt.hex include
  cat <<EOF >> debian.$ltsname/config/config.common.ubuntu
CONFIG_ACPI_CUSTOM_DSDT=y
CONFIG_ACPI_CUSTOM_DSDT_FILE="dsdt.hex"
EOF
fi
dch -lpb -c debian.$ltsname/changelog "Local patches are applied"
fakeroot debian/rules clean
fakeroot debian/rules binary-headers binary-generic
